<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HaruQR - 聚合收款码生成器</title>
  <meta name="description" content="HaruQR - 免费在线聚合微信支付宝收款码生成器，离线安全，数据不上传服务器">
  <meta property="og:title" content="HaruQR - 聚合收款码生成器">
  <meta property="og:description" content="免费在线聚合微信支付宝收款码生成器，离线安全">
  <meta property="og:type" content="website">
  <link rel="icon" href="imgs/ico.webp" type="image/webp">
  <link rel="preconnect" href="https://fonts.loli.net">
  <link rel="preconnect" href="https://gstatic.loli.net" crossorigin>
  <link href="https://fonts.loli.net/css2?family=Cormorant+Garamond:wght@300;400;500&family=Quicksand:wght@300;400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/shared.css">
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <style>
    :root {
      --bg-card: rgba(255, 255, 255, 0.03);
      --border-color: rgba(255, 255, 255, 0.08);
      --border-strong: rgba(255, 255, 255, 0.12);
      --text-tertiary: rgba(255, 255, 255, 0.35);
      --wechat: #07C160;
      --alipay: #1677FF;
      --danger: #EF4444;
      --success: #10B981;
    }

    html { font-size: 16px; -webkit-font-smoothing: antialiased; }

    body {
      line-height: 1.6;
      min-height: 100vh;
    }

    /* Layout */
    .container {
      position: relative; z-index: 2;
      max-width: 640px;
      margin: 0 auto;
      padding: 100px 20px 60px;
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 40px;
    }
    .header h1 {
      font-family: 'Cormorant Garamond', serif;
      font-size: clamp(28px, 6vw, 42px);
      font-weight: 300;
      letter-spacing: 0.05em;
      background: linear-gradient(135deg, var(--wechat), var(--alipay));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 6px;
    }
    .header p {
      font-size: 14px;
      color: var(--text-secondary);
      letter-spacing: 0.05em;
    }

    /* Info Banner */
    .info-banner {
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border-color);
      padding: 14px 18px;
      margin-bottom: 24px;
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.7;
    }
    .secure-badge {
      display: inline-flex; align-items: center; gap: 5px;
      background: rgba(16,185,129,0.12);
      color: var(--success);
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 12px; font-weight: 600;
      margin-bottom: 6px;
    }

    /* Upload Section */
    .upload-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-bottom: 24px;
    }
    .upload-card {
      position: relative;
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      border: 2px dashed var(--border-strong);
      padding: 26px 14px;
      text-align: center;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }
    .upload-card:hover { transform: translateY(-4px); }
    .upload-card.avatar-card { grid-column: 1 / -1; padding: 18px 14px; }
    .upload-card.wechat:hover, .upload-card.wechat.dragover {
      border-color: var(--wechat);
      background: rgba(7, 193, 96, 0.06);
    }
    .upload-card.alipay:hover, .upload-card.alipay.dragover {
      border-color: var(--alipay);
      background: rgba(22, 119, 255, 0.06);
    }
    .upload-card.avatar:hover, .upload-card.avatar.dragover {
      border-color: rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.04);
    }
    .upload-card.dragover { transform: translateY(-2px) scale(1.01); }

    .icon-wrap {
      width: 50px; height: 50px;
      border-radius: 13px;
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 10px;
      transition: transform 0.25s ease;
    }
    .upload-card:hover .icon-wrap { transform: scale(1.06); }
    .upload-card.wechat .icon-wrap { background: rgba(7, 193, 96, 0.12); }
    .upload-card.alipay .icon-wrap { background: rgba(22, 119, 255, 0.12); }
    .upload-card.avatar .icon-wrap { background: rgba(255, 255, 255, 0.06); }
    .icon-wrap svg { width: 26px; height: 26px; }
    .icon-wrap img { width: 28px; height: 28px; object-fit: contain; }

    .upload-card .label { font-size: 14px; font-weight: 500; color: var(--text-primary); margin-bottom: 3px; }
    .upload-card .hint { font-size: 12px; color: var(--text-tertiary); }
    .upload-card input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

    /* Upload preview */
    .upload-card.has-file { border-style: solid; padding: 12px; }
    .upload-card.has-file.wechat { border-color: var(--wechat); }
    .upload-card.has-file.alipay { border-color: var(--alipay); }
    .upload-card.has-file.avatar { border-color: var(--success); }
    .preview-wrap { display: none; }
    .upload-card.has-file .preview-wrap { display: block; }
    .upload-card.has-file .upload-content { display: none; }

    .preview-img {
      width: 100%; max-height: 150px;
      object-fit: contain;
      border-radius: 8px;
    }
    .upload-card.avatar .preview-img {
      width: 72px; height: 72px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto; display: block;
    }
    .preview-badge {
      position: absolute; top: 8px; right: 8px;
      width: 22px; height: 22px;
      background: var(--success); border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
    }
    .preview-badge svg { width: 13px; height: 13px; fill: #fff; }
    .preview-name {
      font-size: 11px; color: var(--text-tertiary); margin-top: 6px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .re-upload { display: inline-block; font-size: 12px; color: var(--accent-blue); margin-top: 3px; font-weight: 500; }

    /* Result Section */
    .result-section {
      opacity: 0;
      transform: translateY(20px);
      pointer-events: none;
      max-height: 0;
      overflow: hidden;
      transition: opacity 0.5s ease, transform 0.5s ease, max-height 0.5s ease;
    }
    .result-section.visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
      max-height: 900px;
      margin-bottom: 36px;
    }
    .payment-card-wrap {
      display: flex; justify-content: center;
      margin-bottom: 18px;
    }

    /* Payment Card */
    .payment-card {
      width: 310px;
      background:
        url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.04' fill-rule='evenodd'%3E%3Cpath d='M0 20L20 0h10L0 30zM40 20L20 40H10l30-30z'/%3E%3C/g%3E%3C/svg%3E") repeat,
        linear-gradient(145deg, #07C160 0%, #06A050 32%, #1677FF 68%, #0958D9 100%);
      border-radius: 20px;
      padding: 30px 22px 22px;
      text-align: center;
      box-shadow: 0 24px 80px rgba(0, 0, 0, 0.4);
      position: relative;
      overflow: hidden;
    }
    .payment-card::after {
      content: '';
      position: absolute;
      top: 0; left: -160%; width: 60%; height: 100%;
      background: linear-gradient(100deg, transparent 20%, rgba(255,255,255,0.07) 50%, transparent 80%);
      transform: skewX(-20deg);
      animation: shimmer 4s ease-in-out infinite;
      pointer-events: none;
    }
    @keyframes shimmer {
      0% { left: -160%; }
      40%, 100% { left: 160%; }
    }

    .avatar-ring {
      width: 68px; height: 68px;
      border-radius: 50%;
      border: 3px solid rgba(255,255,255,0.45);
      margin: 0 auto 12px;
      overflow: hidden;
      background: rgba(255,255,255,0.18);
      display: flex; align-items: center; justify-content: center;
    }
    .avatar-ring img { width: 100%; height: 100%; object-fit: cover; }
    .avatar-ring svg { width: 34px; height: 34px; fill: rgba(255,255,255,0.55); }

    .card-title {
      font-size: 15px; font-weight: 600;
      color: #fff;
      margin-bottom: 16px;
      letter-spacing: 0.04em;
      text-shadow: 0 1px 4px rgba(0,0,0,0.12);
    }

    .qr-area {
      background: #fff;
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 14px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    .qr-display {
      position: relative;
      width: 100%; aspect-ratio: 1/1;
    }
    .qr-display .wechat-qr { width: 100%; height: 100%; display: block; }
    .qr-display .alipay-qr {
      position: absolute;
      right: 0; bottom: 0;
      width: 50%; height: 50%;
      transform: rotate(180deg);
    }

    .pay-methods {
      display: flex; align-items: center; justify-content: center;
      gap: 16px;
    }
    .pay-method {
      display: flex; align-items: center; gap: 5px;
      font-size: 12px; color: rgba(255,255,255,0.85); font-weight: 500;
    }
    .pay-method img { width: 18px; height: 18px; object-fit: contain; }
    .divider-dot {
      width: 3px; height: 3px; border-radius: 50%;
      background: rgba(255,255,255,0.28);
    }
    .card-footer {
      margin-top: 10px;
      font-size: 10px; color: rgba(255,255,255,0.30);
      letter-spacing: 0.06em;
    }

    /* Custom Text Input */
    .custom-text-section { margin-bottom: 24px; }
    .custom-text-input {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border-strong);
      font-size: 14px;
      font-family: 'Quicksand', sans-serif;
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .custom-text-input::placeholder { color: var(--text-tertiary); }
    .custom-text-input:focus {
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.1);
    }
    .input-label {
      display: block;
      font-size: 13px; font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    /* Download Button */
    .download-btn {
      display: flex; align-items: center; justify-content: center;
      gap: 8px;
      width: 100%; max-width: 310px;
      margin: 0 auto;
      padding: 13px 24px;
      background: linear-gradient(135deg, var(--wechat), var(--alipay));
      color: #fff; border: none;
      font-size: 15px; font-weight: 600;
      cursor: pointer;
      font-family: 'Quicksand', sans-serif;
      box-shadow: 0 4px 16px rgba(7,193,96,0.22);
      transition: all 0.25s ease;
    }
    .download-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(7,193,96,0.32); }
    .download-btn:active { transform: translateY(0); }
    .download-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .download-btn svg { width: 18px; height: 18px; flex-shrink: 0; }


    /* Toast */
    .toast {
      position: fixed; top: 20px; left: 50%;
      transform: translateX(-50%) translateY(-110px);
      padding: 11px 22px;
      font-size: 14px; font-weight: 500;
      font-family: 'Quicksand', sans-serif;
      z-index: 9999;
      transition: transform 0.4s cubic-bezier(0.68,-0.55,0.27,1.55);
      white-space: nowrap;
      max-width: calc(100vw - 40px);
      border-radius: 8px;
    }
    .toast.error { background: var(--danger); color: #fff; box-shadow: 0 8px 28px rgba(239,68,68,0.28); }
    .toast.success { background: var(--success); color: #fff; box-shadow: 0 8px 28px rgba(16,185,129,0.28); }
    .toast.show { transform: translateX(-50%) translateY(0); }

    /* Animations */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(14px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .anim-in { animation: fadeInUp 0.5s ease both; }
    .anim-d1 { animation-delay: .08s; }
    .anim-d2 { animation-delay: .16s; }
    .anim-d3 { animation-delay: .24s; }

    /* Responsive */
    @media (max-width: 768px) {
      .container { padding: 80px 20px 40px; }
    }
    @media (max-width: 480px) {
      .header h1 { font-size: 24px; }
      .upload-section { gap: 10px; }
      .upload-card { padding: 20px 10px; }
      .payment-card { width: 272px; padding: 24px 16px 18px; }
    }
  </style>
</head>
<body>
  <div class="custom-cursor" id="custom-cursor"></div>
  <div id="sky-container"></div>
  <div class="gradient-overlay"></div>
  <div class="horizon-glow"></div>

  <div id="toast" class="toast"></div>

  <div class="container">
    <a href="pay.html" class="back-button">&larr; Back</a>

    <!-- Header -->
    <header class="header anim-in">
      <h1>HaruQR</h1>
      <p>聚合收款码生成器 · 离线安全 <span style="font-size:11px;color:var(--text-tertiary);">v1.0</span></p>
    </header>

    <!-- Info -->
    <div class="info-banner anim-in anim-d1">
      <div class="secure-badge">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        离线运行
      </div>
      <div>所有二维码解析与合并均在您的浏览器中离线完成，无需服务器参与，不会上传、存储或发送您的任何数据。<br>项目参考 <a href="https://github.com/uxiaohan/PayQrcode" target="_blank" rel="noopener" style="color: var(--accent-blue); text-decoration: none;">PayQrcode</a></div>
    </div>

    <!-- Upload -->
    <section class="upload-section anim-in anim-d2">
      <!-- WeChat -->
      <div class="upload-card wechat" id="wechatCard">
        <div class="upload-content">
          <div class="icon-wrap">
            <img src="imgs/wechat.png" alt="微信">
          </div>
          <div class="label">微信收款码</div>
          <div class="hint">点击或拖拽上传</div>
        </div>
        <div class="preview-wrap">
          <img class="preview-img" id="wechatPreview" alt="">
          <div class="preview-badge"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></div>
          <div class="preview-name" id="wechatName"></div>
          <span class="re-upload">重新上传</span>
        </div>
        <input type="file" accept="image/*" id="wechatInput">
      </div>

      <!-- Alipay -->
      <div class="upload-card alipay" id="alipayCard">
        <div class="upload-content">
          <div class="icon-wrap">
            <img src="imgs/alipay-pay.png" alt="支付宝">
          </div>
          <div class="label">支付宝收款码</div>
          <div class="hint">点击或拖拽上传</div>
        </div>
        <div class="preview-wrap">
          <img class="preview-img" id="alipayPreview" alt="">
          <div class="preview-badge"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></div>
          <div class="preview-name" id="alipayName"></div>
          <span class="re-upload">重新上传</span>
        </div>
        <input type="file" accept="image/*" id="alipayInput">
      </div>

      <!-- Avatar -->
      <div class="upload-card avatar avatar-card" id="avatarCard">
        <div class="upload-content">
          <div class="icon-wrap">
            <svg viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="8" r="4" stroke="rgba(255,255,255,0.4)" stroke-width="2"/>
              <path d="M4 21c0-3.87 3.58-7 8-7s8 3.13 8 7" stroke="rgba(255,255,255,0.4)" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="label">个人头像（可选）</div>
          <div class="hint">点击或拖拽上传，用于展示在收款卡片上</div>
        </div>
        <div class="preview-wrap">
          <img class="preview-img" id="avatarPreview" alt="">
          <div class="preview-name" id="avatarName"></div>
          <span class="re-upload">重新上传</span>
        </div>
        <input type="file" accept="image/*" id="avatarInput">
      </div>
    </section>

    <!-- Custom Text -->
    <div class="custom-text-section anim-in anim-d3">
      <label class="input-label" for="cardTitleInput">卡片显示文字</label>
      <input class="custom-text-input" type="text" id="cardTitleInput" placeholder="扫码向我付款" maxlength="20">
    </div>

    <!-- Result -->
    <section class="result-section" id="resultSection">
      <div class="payment-card-wrap">
        <div class="payment-card" id="paymentCard">
          <div class="avatar-ring" id="cardAvatar">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M4 21c0-3.87 3.58-7 8-7s8 3.13 8 7"/></svg>
          </div>
          <div class="card-title">扫码向我付款</div>
          <div class="qr-area">
            <div class="qr-display" id="qrDisplay">
              <img class="wechat-qr" id="wechatQr" alt="">
              <img class="alipay-qr" id="alipayQr" alt="">
            </div>
          </div>
          <div class="pay-methods">
            <span class="pay-method"><img src="imgs/wechat.png" alt="微信">微信</span>
            <span class="divider-dot"></span>
            <span class="pay-method"><img src="imgs/alipay-pay.png" alt="支付宝">支付宝</span>
          </div>
          <div class="card-footer">Powered by HaruQR</div>
        </div>
      </div>
      <button class="download-btn" id="downloadBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
        </svg>
        生成收款码
      </button>
    </section>

    <footer class="footer"></footer>
  </div>


  <!-- Functional JS -->
  <script>
  (() => {
    // --- State ---
    let wechatData = null;
    let alipayData = null;
    let avatarUrl = null;

    const wechatWhitelist = ['wxp://', 'weixin.qq.com', 'wechatpay.cn'];
    const alipayWhitelist = ['alipay.com'];

    // --- DOM ---
    const $ = id => document.getElementById(id);
    const wechatCard = $('wechatCard'), alipayCard = $('alipayCard'), avatarCard = $('avatarCard');
    const wechatInput = $('wechatInput'), alipayInput = $('alipayInput'), avatarInput = $('avatarInput');
    const resultSection = $('resultSection');
    const downloadBtn = $('downloadBtn');
    const downloadBtnHTML = downloadBtn.innerHTML;

    // --- Toast ---
    function showToast(msg, type) {
      const t = $('toast');
      t.textContent = msg;
      t.className = 'toast ' + (type || 'error') + ' show';
      clearTimeout(t._t);
      t._t = setTimeout(() => t.classList.remove('show'), 3000);
    }

    // --- Decode QR from image file ---
    function decodeQR(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = new Image();
          img.onload = () => {
            const c = document.createElement('canvas');
            c.width = img.width; c.height = img.height;
            const ctx = c.getContext('2d');
            ctx.drawImage(img, 0, 0);
            const d = ctx.getImageData(0, 0, c.width, c.height);
            const code = jsQR(d.data, d.width, d.height, { inversionAttempts: 'dontInvert' });
            if (code && code.data) {
              resolve({ data: code.data, dataUrl: e.target.result });
            } else {
              reject(new Error('无法识别二维码，请裁剪后重试'));
            }
          };
          img.onerror = () => reject(new Error('图片加载失败'));
          img.src = e.target.result;
        };
        reader.onerror = () => reject(new Error('文件读取失败'));
        reader.readAsDataURL(file);
      });
    }

    // --- Generate QR on canvas ---
    async function generateQR(data, size, clearBR) {
      const canvas = document.createElement('canvas');
      await QRCode.toCanvas(canvas, data, {
        errorCorrectionLevel: 'H',
        width: size, margin: 0,
        color: { dark: '#000000', light: '#ffffff' }
      });
      if (clearBR) {
        const ctx = canvas.getContext('2d');
        const clearW = (size / 2) * 0.5;
        ctx.clearRect(size / 2, size - clearW, size / 2, clearW);
      }
      return canvas.toDataURL('image/png');
    }

    // --- Try generating merged result ---
    async function tryGenerate() {
      if (!wechatData || !alipayData) return;
      try {
        const size = 500;
        const wechatQrUrl = await generateQR(wechatData, size, false);
        const alipayQrUrl = await generateQR(alipayData, size, true);
        $('wechatQr').src = wechatQrUrl;
        $('alipayQr').src = alipayQrUrl;
        updateCardAvatar();
        resultSection.classList.add('visible');
        setTimeout(() => {
          resultSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
        showToast('聚合收款码生成成功！', 'success');
      } catch (err) {
        showToast('生成失败：' + err.message);
      }
    }

    // --- Update card avatar ---
    function updateCardAvatar() {
      const el = $('cardAvatar');
      if (avatarUrl) {
        el.innerHTML = '<img src="' + avatarUrl + '">';
      } else {
        el.innerHTML = '<svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M4 21c0-3.87 3.58-7 8-7s8 3.13 8 7"/></svg>';
      }
    }

    // --- Upload card setup ---
    function setupCard(card, input, handler) {
      ['dragenter', 'dragover'].forEach(ev =>
        card.addEventListener(ev, e => { e.preventDefault(); card.classList.add('dragover'); })
      );
      ['dragleave', 'drop'].forEach(ev =>
        card.addEventListener(ev, e => { e.preventDefault(); card.classList.remove('dragover'); })
      );
      card.addEventListener('drop', e => {
        const f = e.dataTransfer.files[0];
        if (f) handler(f);
      });
      input.addEventListener('change', e => {
        const f = e.target.files[0];
        if (f) handler(f);
        e.target.value = '';
      });
    }

    // --- WeChat handler ---
    async function handleWechat(file) {
      try {
        const { data, dataUrl } = await decodeQR(file);
        if (!wechatWhitelist.some(w => data.toLowerCase().includes(w))) {
          showToast('请上传正确的微信收款码');
          return;
        }
        wechatData = data;
        $('wechatPreview').src = dataUrl;
        $('wechatName').textContent = file.name;
        wechatCard.classList.add('has-file');
        await tryGenerate();
      } catch (err) {
        showToast(err.message);
      }
    }

    // --- Alipay handler ---
    async function handleAlipay(file) {
      try {
        const { data, dataUrl } = await decodeQR(file);
        if (!alipayWhitelist.some(w => data.toLowerCase().includes(w))) {
          showToast('请上传正确的支付宝收款码');
          return;
        }
        alipayData = data;
        $('alipayPreview').src = dataUrl;
        $('alipayName').textContent = file.name;
        alipayCard.classList.add('has-file');
        await tryGenerate();
      } catch (err) {
        showToast(err.message);
      }
    }

    // --- Avatar handler ---
    function handleAvatar(file) {
      const reader = new FileReader();
      reader.onload = e => {
        avatarUrl = e.target.result;
        $('avatarPreview').src = avatarUrl;
        $('avatarName').textContent = file.name;
        avatarCard.classList.add('has-file');
        updateCardAvatar();
      };
      reader.readAsDataURL(file);
    }

    // --- Canvas card rendering (replaces html2canvas) ---
    function loadImg(src) {
      return new Promise(function(resolve) {
        if (!src) { resolve(null); return; }
        var img = new Image();
        img.onload = function() { resolve(img); };
        img.onerror = function() { resolve(null); };
        img.src = src;
      });
    }

    function rrect(ctx, x, y, w, h, r) {
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.lineTo(x + w - r, y);
      ctx.quadraticCurveTo(x + w, y, x + w, y + r);
      ctx.lineTo(x + w, y + h - r);
      ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
      ctx.lineTo(x + r, y + h);
      ctx.quadraticCurveTo(x, y + h, x, y + h - r);
      ctx.lineTo(x, y + r);
      ctx.quadraticCurveTo(x, y, x + r, y);
      ctx.closePath();
    }

    async function renderCardCanvas() {
      var s = 2;
      var W = 310 * s, px = 22 * s;
      var ptop = 30 * s, pbottom = 22 * s;
      var avD = 68 * s, avB = 3 * s;
      var qrPad = 12 * s;
      var qrSize = W - px * 2 - qrPad * 2;
      var H = ptop + avD + 12*s + 18*s + 16*s + (qrSize + qrPad*2) + 14*s + 20*s + 10*s + 12*s + pbottom;

      var c = document.createElement('canvas');
      c.width = W; c.height = H;
      var ctx = c.getContext('2d');

      // --- Background ---
      var grad = ctx.createLinearGradient(0, 0, W * 0.6, H);
      grad.addColorStop(0, '#07C160');
      grad.addColorStop(0.32, '#06A050');
      grad.addColorStop(0.68, '#1677FF');
      grad.addColorStop(1, '#0958D9');
      rrect(ctx, 0, 0, W, H, 20 * s);
      ctx.fillStyle = grad;
      ctx.fill();

      var y = ptop;

      // --- Avatar ---
      var cx = W / 2, cy = y + avD / 2;
      ctx.beginPath();
      ctx.arc(cx, cy, avD / 2, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(255,255,255,0.18)';
      ctx.fill();
      ctx.strokeStyle = 'rgba(255,255,255,0.45)';
      ctx.lineWidth = avB;
      ctx.stroke();

      if (avatarUrl) {
        var avImg = await loadImg(avatarUrl);
        if (avImg) {
          ctx.save();
          ctx.beginPath();
          ctx.arc(cx, cy, avD / 2 - avB, 0, Math.PI * 2);
          ctx.clip();
          ctx.drawImage(avImg, cx - avD/2 + avB, cy - avD/2 + avB, avD - avB*2, avD - avB*2);
          ctx.restore();
        }
      } else {
        ctx.fillStyle = 'rgba(255,255,255,0.55)';
        ctx.beginPath();
        ctx.arc(cx, cy - 6*s, 8*s, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.moveTo(cx - 16*s, cy + 20*s);
        ctx.quadraticCurveTo(cx, cy + 4*s, cx + 16*s, cy + 20*s);
        ctx.fill();
      }
      y += avD + 12 * s;

      // --- Title ---
      var title = cardTitleInput.value || '扫码向我付款';
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold ' + (15*s) + 'px "Quicksand", sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.shadowColor = 'rgba(0,0,0,0.12)';
      ctx.shadowBlur = 4 * s;
      ctx.fillText(title, W / 2, y);
      ctx.shadowColor = 'transparent';
      ctx.shadowBlur = 0;
      y += 18 * s + 16 * s;

      // --- QR white area ---
      var qrAX = px, qrAY = y, qrAW = W - px * 2, qrAH = qrSize + qrPad * 2;
      rrect(ctx, qrAX, qrAY, qrAW, qrAH, 14 * s);
      ctx.fillStyle = '#ffffff';
      ctx.fill();
      ctx.shadowColor = 'rgba(0,0,0,0.08)';
      ctx.shadowBlur = 10 * s;
      ctx.fill();
      ctx.shadowColor = 'transparent';
      ctx.shadowBlur = 0;

      // WeChat QR (full)
      var wImg = await loadImg($('wechatQr').src);
      if (wImg) ctx.drawImage(wImg, qrAX + qrPad, qrAY + qrPad, qrSize, qrSize);

      // Alipay QR (bottom-right, rotated 180°)
      var aImg = await loadImg($('alipayQr').src);
      if (aImg) {
        var aS = qrSize / 2;
        var ax = qrAX + qrPad + qrSize - aS / 2;
        var ay = qrAY + qrPad + qrSize - aS / 2;
        ctx.save();
        ctx.translate(ax, ay);
        ctx.rotate(Math.PI);
        ctx.drawImage(aImg, -aS / 2, -aS / 2, aS, aS);
        ctx.restore();
      }
      y += qrAH + 14 * s;

      // --- Payment methods ---
      var wIcon = await loadImg('imgs/wechat.png');
      var aIcon = await loadImg('imgs/alipay-pay.png');
      var icoS = 18 * s, gap = 5 * s;
      ctx.font = '500 ' + (12*s) + 'px "Quicksand", sans-serif';
      ctx.textBaseline = 'middle';
      var midY = y + 10 * s;
      var wTxt = '微信', aTxt = '支付宝';
      var wW = ctx.measureText(wTxt).width, aW = ctx.measureText(aTxt).width;
      var dotR = 1.5 * s, dotGap = 16 * s;
      var totalW = icoS + gap + wW + dotGap + dotR*2 + dotGap + icoS + gap + aW;
      var mx = (W - totalW) / 2;

      ctx.fillStyle = 'rgba(255,255,255,0.85)';
      if (wIcon) ctx.drawImage(wIcon, mx, midY - icoS/2, icoS, icoS);
      mx += icoS + gap;
      ctx.textAlign = 'left';
      ctx.fillText(wTxt, mx, midY);
      mx += wW + dotGap;

      ctx.beginPath();
      ctx.arc(mx + dotR, midY, dotR, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(255,255,255,0.28)';
      ctx.fill();
      mx += dotR * 2 + dotGap;

      ctx.fillStyle = 'rgba(255,255,255,0.85)';
      if (aIcon) ctx.drawImage(aIcon, mx, midY - icoS/2, icoS, icoS);
      mx += icoS + gap;
      ctx.fillText(aTxt, mx, midY);
      y += 20 * s + 10 * s;

      // --- Footer ---
      ctx.font = (10*s) + 'px "Quicksand", sans-serif';
      ctx.fillStyle = 'rgba(255,255,255,0.30)';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.fillText('Powered by HaruQR', W / 2, y);

      return c.toDataURL('image/png');
    }

    // --- Download ---
    const cardWrap = document.querySelector('.payment-card-wrap');
    let cardOriginalHTML = null;

    function restoreCard() {
      if (!cardOriginalHTML) return;
      cardWrap.innerHTML = cardOriginalHTML;
      cardOriginalHTML = null;
      downloadBtn.style.display = '';
      const editBtn = $('editCardBtn');
      if (editBtn) editBtn.remove();
    }

    async function handleDownload() {
      downloadBtn.disabled = true;
      downloadBtn.innerHTML = '生成中...';

      var dataUrl;
      try {
        dataUrl = await renderCardCanvas();
      } catch (err) {
        showToast('生成失败，请重试');
        downloadBtn.disabled = false;
        downloadBtn.innerHTML = downloadBtnHTML;
        return;
      }

      // Replace HTML card with single image for long-press save
      cardOriginalHTML = cardWrap.innerHTML;
      cardWrap.innerHTML = '<img src="' + dataUrl + '" style="width:310px;max-width:100%;border-radius:20px;display:block;margin:0 auto;">';

      // Hide generate button, show hint + re-edit button
      downloadBtn.style.display = 'none';
      downloadBtn.disabled = false;
      downloadBtn.innerHTML = downloadBtnHTML;

      var editBtn = document.createElement('button');
      editBtn.id = 'editCardBtn';
      editBtn.className = 'download-btn';
      editBtn.style.background = 'rgba(255,255,255,0.08)';
      editBtn.style.boxShadow = 'none';
      editBtn.innerHTML = '长按上方图片保存完整名片 · 点此重新编辑';
      editBtn.addEventListener('click', restoreCard);
      downloadBtn.parentNode.insertBefore(editBtn, downloadBtn);
    }

    // --- Custom title text ---
    const cardTitleInput = $('cardTitleInput');
    const cardTitleEl = document.querySelector('.card-title');
    cardTitleInput.addEventListener('input', () => {
      cardTitleEl.textContent = cardTitleInput.value || '扫码向我付款';
    });

    // --- Init ---
    setupCard(wechatCard, wechatInput, handleWechat);
    setupCard(alipayCard, alipayInput, handleAlipay);
    setupCard(avatarCard, avatarInput, handleAvatar);
    downloadBtn.addEventListener('click', handleDownload);
  })();
  </script>

  <script src="js/sky-background.js?v=2"></script>
  <script src="js/custom-cursor.js"></script>
  <script>
    SkyBackground.init('a, button, input, textarea, select, .upload-card, .download-btn');
    CustomCursor.init('a, button, .upload-card, .download-btn, .back-button');
  </script>
</body>
</html>
